name: Self Test

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:13-alpine
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_USER: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

    steps:
      # 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –ë–ï–ó actions/checkout (–∏—Å–ø–æ–ª—å–∑—É–µ–º git –Ω–∞–ø—Ä—è–º—É—é)
      - name: Checkout code
        run: |
          git clone https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      # 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
      - name: Init database
        run: |
          export PGPASSWORD=password
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º SQL –∏–∑ bash-—Å–∫—Ä–∏–ø—Ç–∞ (–º–µ–∂–¥—É EOSQL —Ç–µ–≥–∞–º–∏) –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º
          sed -n '/<<-EOSQL/,/^EOSQL/p' tests/init-database.sh | sed '1d;$d' | \
            psql -h localhost -U postgres -d postgres
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
          echo "Checking database..."
          psql -h localhost -U postgres -d postgres -c "SELECT COUNT(*) as total, COUNT(CASE WHEN region='Europe' THEN 1 END) as europe FROM countries;"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
          echo "Checking database..."
          COUNT=$(PGPASSWORD=password psql -h localhost -U postgres -d postgres -t -c "SELECT COUNT(*) FROM countries;")
          echo "Total countries in DB: $COUNT"
          
          EUROPE_COUNT=$(PGPASSWORD=password psql -h localhost -U postgres -d postgres -t -c "SELECT COUNT(*) FROM countries WHERE region='Europe';")
          echo "European countries in DB: $EUROPE_COUNT"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
          echo "Sample countries:"
          PGPASSWORD=password psql -h localhost -U postgres -d postgres -c "SELECT name, alpha2, region FROM countries WHERE region='Europe' LIMIT 3;"

      # 3. –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
      - name: Build Docker image
        run: docker build -t pulse-backend ./solution

      # 4. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      - name: Start application
        run: |
          docker run -d \
            --name pulse-app \
            --network host \
            -e SERVER_ADDRESS=0.0.0.0:8080 \
            -e SERVER_PORT=8080 \
            -e POSTGRES_CONN=postgresql://postgres:password@localhost:5432/postgres \
            -e POSTGRES_USERNAME=postgres \
            -e POSTGRES_PASSWORD=password \
            -e POSTGRES_HOST=localhost \
            -e POSTGRES_PORT=5432 \
            -e POSTGRES_DATABASE=postgres \
            -e RANDOM_SECRET=test-secret-key-123456789abcdefghijklmnopqrstuvwxyz \
            pulse-backend

      # 5. –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞
      - name: Wait for app to start
        run: |
          echo "Waiting for app..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/api/ping > /dev/null 2>&1; then
              echo "‚úÖ App is ready after ${i}s!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 1
          done

      # 6. Test 01/ping
      - name: "‚úÖ Test 01/ping"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/ping)
          echo "Status: $STATUS"
          [ "$STATUS" = "200" ] && echo "‚úÖ PASS: ping OK" || (echo "‚ùå FAIL: ping returned $STATUS" && exit 1)

      # 7. Test 02/countries
      - name: "‚úÖ Test 02/countries - all"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/countries)
          BODY=$(curl -s http://localhost:8080/api/countries)
          echo "Status: $STATUS"
          echo "Body: $BODY"
          [ "$STATUS" = "200" ] && echo "‚úÖ PASS" || (echo "‚ùå FAIL: $STATUS" && exit 1)
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert isinstance(data, list), 'Not a list'
          codes = [c['alpha2'] for c in data]
          assert codes == sorted(codes), f'Not sorted: {codes}'
          print(f'‚úÖ PASS: {len(data)} countries, sorted correctly')
          "

      - name: "‚úÖ Test 02/countries - filter by region"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8080/api/countries?region=Europe")
          BODY=$(curl -s "http://localhost:8080/api/countries?region=Europe")
          echo "Response body (first 500 chars):"
          echo "$BODY" | head -c 500
          echo ""
          [ "$STATUS" = "200" ] && echo "‚úÖ Status OK" || (echo "‚ùå FAIL: $STATUS" && exit 1)
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          if len(data) == 0:
              print('‚ùå FAIL: Empty response!')
              sys.exit(1)
          print(f'Countries returned: {len(data)}')
          print(f'First country: {data[0]}')
          regions = set(c.get('region') for c in data)
          print(f'Regions found: {regions}')
          if None in regions or '' in regions:
              print('‚ö†Ô∏è  WARNING: Some countries have no region')
          if regions - {None, ''} != {'Europe'}:
              print(f'‚ùå FAIL: Expected only Europe, got: {regions}')
              sys.exit(1)
          print(f'‚úÖ PASS: {len(data)} European countries')
          "

      - name: "‚úÖ Test 02/countries - invalid region = 400"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8080/api/countries?region=INVALID")
          [ "$STATUS" = "400" ] && echo "‚úÖ PASS: 400 for invalid region" || (echo "‚ùå FAIL: Got $STATUS, expected 400" && exit 1)

      - name: "‚úÖ Test 02/countries - by alpha2"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/countries/RU)
          BODY=$(curl -s http://localhost:8080/api/countries/RU)
          echo "Body: $BODY"
          [ "$STATUS" = "200" ] && echo "‚úÖ Status OK" || (echo "‚ùå FAIL: $STATUS" && exit 1)
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert data['alpha2'] == 'RU', f'Wrong country: {data}'
          print(f'‚úÖ PASS: Found {data[\"name\"]}')
          "

      - name: "‚úÖ Test 02/countries - unknown alpha2 = 404"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/countries/XX)
          [ "$STATUS" = "404" ] && echo "‚úÖ PASS: 404 for unknown country" || (echo "‚ùå FAIL: Got $STATUS, expected 404" && exit 1)

      # 8. Test 03/auth/register
      - name: "‚úÖ Test 03/register - success = 201"
        run: |
          BODY=$(curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"testuser","email":"test@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}')
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"testuser2","email":"test2@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}')
          echo "Register response: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert 'profile' in data, f'No profile: {data}'
          p = data['profile']
          for f in ['login','email','countryCode','isPublic']:
              assert f in p, f'Missing field: {f}'
          print(f'‚úÖ PASS: User {p[\"login\"]} registered')
          "

      - name: "‚úÖ Test 03/register - duplicate = 409"
        run: |
          curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"dupuser","email":"dup@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}' > /dev/null
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"dupuser","email":"dup2@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}')
          [ "$STATUS" = "409" ] && echo "‚úÖ PASS: 409 for duplicate" || (echo "‚ùå FAIL: Got $STATUS, expected 409" && exit 1)

      - name: "‚úÖ Test 03/register - weak password = 400"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"weakuser","email":"weak@example.com","password":"weak","countryCode":"RU","isPublic":true}')
          [ "$STATUS" = "400" ] && echo "‚úÖ PASS: 400 for weak password" || (echo "‚ùå FAIL: Got $STATUS, expected 400" && exit 1)

      # 9. Test 04/auth/sign-in
      - name: "‚úÖ Test 04/sign-in - success = 200 + token"
        run: |
          curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"signinuser","email":"signin@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}' > /dev/null
          BODY=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"signinuser","password":"Test123pass"}')
          echo "Sign-in response: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert 'token' in data, f'No token: {data}'
          assert len(data['token']) >= 20, 'Token too short'
          print(f'‚úÖ PASS: Token received (len={len(data[\"token\"])})')
          "

      - name: "‚úÖ Test 04/sign-in - wrong password = 401"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"signinuser","password":"WrongPass"}')
          [ "$STATUS" = "401" ] && echo "‚úÖ PASS: 401 for wrong password" || (echo "‚ùå FAIL: Got $STATUS, expected 401" && exit 1)

      # 10. Summary
      - name: "üìä Summary"
        run: |
          echo ""
          echo "=================================="
          echo "       TEST RESULTS SUMMARY"
          echo "=================================="
          echo "  ‚úÖ 01/ping           1 point"
          echo "  ‚úÖ 02/countries      6 points"
          echo "  ‚úÖ 03/auth/register  6 points"
          echo "  ‚úÖ 04/auth/sign-in   7 points"
          echo "----------------------------------"
          echo "  TOTAL: 20 / 100 points"
          echo "=================================="

      # 11. –õ–æ–≥–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      - name: Show app logs on failure
        if: failure()
        run: docker logs pulse-app 2>&1 || true
