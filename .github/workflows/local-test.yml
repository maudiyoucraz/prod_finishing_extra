name: Self Test

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:13-alpine
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_USER: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

    steps:
      # 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ´ Ğ‘Ğ•Ğ— actions/checkout (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ git Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ)
      - name: Checkout code
        run: |
          git clone https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      # 2. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
      - name: Init database
        run: |
          # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¸Ğ· Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
          export POSTGRES_USER=postgres
          export POSTGRES_DB=postgres
          export PGPASSWORD=password
          
          # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ SQL Ğ¸Ğ· init-database.sh
          psql -h localhost -U postgres -d postgres -f tests/init-database.sh

      # 3. Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Docker Ğ¾Ğ±Ñ€Ğ°Ğ·
      - name: Build Docker image
        run: docker build -t pulse-backend ./solution

      # 4. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
      - name: Start application
        run: |
          docker run -d \
            --name pulse-app \
            --network host \
            -e SERVER_ADDRESS=0.0.0.0:8080 \
            -e SERVER_PORT=8080 \
            -e POSTGRES_CONN=postgresql://postgres:password@localhost:5432/postgres \
            -e POSTGRES_USERNAME=postgres \
            -e POSTGRES_PASSWORD=password \
            -e POSTGRES_HOST=localhost \
            -e POSTGRES_PORT=5432 \
            -e POSTGRES_DATABASE=postgres \
            -e RANDOM_SECRET=test-secret-key-123456789abcdefghijklmnopqrstuvwxyz \
            pulse-backend

      # 5. Ğ–Ğ´Ñ‘Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
      - name: Wait for app to start
        run: |
          echo "Waiting for app..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/api/ping > /dev/null 2>&1; then
              echo "âœ… App is ready after ${i}s!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 1
          done

      # 6. Test 01/ping
      - name: "âœ… Test 01/ping"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/ping)
          echo "Status: $STATUS"
          [ "$STATUS" = "200" ] && echo "âœ… PASS: ping OK" || (echo "âŒ FAIL: ping returned $STATUS" && exit 1)

      # 7. Test 02/countries
      - name: "âœ… Test 02/countries - all"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/countries)
          BODY=$(curl -s http://localhost:8080/api/countries)
          echo "Status: $STATUS"
          echo "Body: $BODY"
          [ "$STATUS" = "200" ] && echo "âœ… PASS" || (echo "âŒ FAIL: $STATUS" && exit 1)
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert isinstance(data, list), 'Not a list'
          codes = [c['alpha2'] for c in data]
          assert codes == sorted(codes), f'Not sorted: {codes}'
          print(f'âœ… PASS: {len(data)} countries, sorted correctly')
          "

      - name: "âœ… Test 02/countries - filter by region"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8080/api/countries?region=Europe")
          BODY=$(curl -s "http://localhost:8080/api/countries?region=Europe")
          [ "$STATUS" = "200" ] && echo "âœ… Status OK" || (echo "âŒ FAIL: $STATUS" && exit 1)
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          regions = set(c.get('region') for c in data)
          assert regions == {'Europe'}, f'Wrong regions: {regions}'
          print(f'âœ… PASS: {len(data)} European countries')
          "

      - name: "âœ… Test 02/countries - invalid region = 400"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8080/api/countries?region=INVALID")
          [ "$STATUS" = "400" ] && echo "âœ… PASS: 400 for invalid region" || (echo "âŒ FAIL: Got $STATUS, expected 400" && exit 1)

      - name: "âœ… Test 02/countries - by alpha2"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/countries/RU)
          BODY=$(curl -s http://localhost:8080/api/countries/RU)
          echo "Body: $BODY"
          [ "$STATUS" = "200" ] && echo "âœ… Status OK" || (echo "âŒ FAIL: $STATUS" && exit 1)
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert data['alpha2'] == 'RU', f'Wrong country: {data}'
          print(f'âœ… PASS: Found {data[\"name\"]}')
          "

      - name: "âœ… Test 02/countries - unknown alpha2 = 404"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/countries/XX)
          [ "$STATUS" = "404" ] && echo "âœ… PASS: 404 for unknown country" || (echo "âŒ FAIL: Got $STATUS, expected 404" && exit 1)

      # 8. Test 03/auth/register
      - name: "âœ… Test 03/register - success = 201"
        run: |
          BODY=$(curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"testuser","email":"test@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}')
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"testuser2","email":"test2@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}')
          echo "Register response: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert 'profile' in data, f'No profile: {data}'
          p = data['profile']
          for f in ['login','email','countryCode','isPublic']:
              assert f in p, f'Missing field: {f}'
          print(f'âœ… PASS: User {p[\"login\"]} registered')
          "

      - name: "âœ… Test 03/register - duplicate = 409"
        run: |
          curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"dupuser","email":"dup@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}' > /dev/null
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"dupuser","email":"dup2@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}')
          [ "$STATUS" = "409" ] && echo "âœ… PASS: 409 for duplicate" || (echo "âŒ FAIL: Got $STATUS, expected 409" && exit 1)

      - name: "âœ… Test 03/register - weak password = 400"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"weakuser","email":"weak@example.com","password":"weak","countryCode":"RU","isPublic":true}')
          [ "$STATUS" = "400" ] && echo "âœ… PASS: 400 for weak password" || (echo "âŒ FAIL: Got $STATUS, expected 400" && exit 1)

      # 9. Test 04/auth/sign-in
      - name: "âœ… Test 04/sign-in - success = 200 + token"
        run: |
          curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"signinuser","email":"signin@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}' > /dev/null
          BODY=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"signinuser","password":"Test123pass"}')
          echo "Sign-in response: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert 'token' in data, f'No token: {data}'
          assert len(data['token']) >= 20, 'Token too short'
          print(f'âœ… PASS: Token received (len={len(data[\"token\"])})')
          "

      - name: "âœ… Test 04/sign-in - wrong password = 401"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"signinuser","password":"WrongPass"}')
          [ "$STATUS" = "401" ] && echo "âœ… PASS: 401 for wrong password" || (echo "âŒ FAIL: Got $STATUS, expected 401" && exit 1)

      # 10. Summary
      - name: "ğŸ“Š Summary"
        run: |
          echo ""
          echo "=================================="
          echo "       TEST RESULTS SUMMARY"
          echo "=================================="
          echo "  âœ… 01/ping           1 point"
          echo "  âœ… 02/countries      6 points"
          echo "  âœ… 03/auth/register  6 points"
          echo "  âœ… 04/auth/sign-in   7 points"
          echo "----------------------------------"
          echo "  TOTAL: 20 / 100 points"
          echo "=================================="

      # 11. Ğ›Ğ¾Ğ³Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
      - name: Show app logs on failure
        if: failure()
        run: docker logs pulse-app 2>&1 || true
