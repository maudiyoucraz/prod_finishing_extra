name: Self Test

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:13-alpine
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_USER: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

    steps:
      # 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –ë–ï–ó actions/checkout (–∏—Å–ø–æ–ª—å–∑—É–µ–º git –Ω–∞–ø—Ä—è–º—É—é)
      - name: Checkout code
        run: |
          git clone https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      # 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
      - name: Init database
        run: |
          export PGPASSWORD=password
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º SQL –∏–∑ bash-—Å–∫—Ä–∏–ø—Ç–∞ (–º–µ–∂–¥—É EOSQL —Ç–µ–≥–∞–º–∏) –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º
          sed -n '/<<-EOSQL/,/^EOSQL/p' tests/init-database.sh | sed '1d;$d' | \
            psql -h localhost -U postgres -d postgres
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
          echo "Checking database..."
          psql -h localhost -U postgres -d postgres -c "SELECT COUNT(*) as total, COUNT(CASE WHEN region='Europe' THEN 1 END) as europe FROM countries;"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
          echo "Checking database..."
          COUNT=$(PGPASSWORD=password psql -h localhost -U postgres -d postgres -t -c "SELECT COUNT(*) FROM countries;")
          echo "Total countries in DB: $COUNT"
          
          EUROPE_COUNT=$(PGPASSWORD=password psql -h localhost -U postgres -d postgres -t -c "SELECT COUNT(*) FROM countries WHERE region='Europe';")
          echo "European countries in DB: $EUROPE_COUNT"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
          echo "Sample countries:"
          PGPASSWORD=password psql -h localhost -U postgres -d postgres -c "SELECT name, alpha2, region FROM countries WHERE region='Europe' LIMIT 3;"

      # 3. –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
      - name: Build Docker image
        run: docker build -t pulse-backend ./solution

      # 4. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      - name: Start application
        run: |
          docker run -d \
            --name pulse-app \
            --network host \
            -e SERVER_ADDRESS=0.0.0.0:8080 \
            -e SERVER_PORT=8080 \
            -e POSTGRES_CONN=postgresql://postgres:password@localhost:5432/postgres \
            -e POSTGRES_USERNAME=postgres \
            -e POSTGRES_PASSWORD=password \
            -e POSTGRES_HOST=localhost \
            -e POSTGRES_PORT=5432 \
            -e POSTGRES_DATABASE=postgres \
            -e RANDOM_SECRET=test-secret-key-123456789abcdefghijklmnopqrstuvwxyz \
            pulse-backend

      # 5. –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞
      - name: Wait for app to start
        run: |
          echo "Waiting for app..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/api/ping > /dev/null 2>&1; then
              echo "‚úÖ App is ready after ${i}s!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 1
          done

      # 6. Test 01/ping
      - name: "‚úÖ Test 01/ping"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/ping)
          echo "Status: $STATUS"
          [ "$STATUS" = "200" ] && echo "‚úÖ PASS: ping OK" || (echo "‚ùå FAIL: ping returned $STATUS" && exit 1)

      # 7. Test 02/countries
      - name: "‚úÖ Test 02/countries - all"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/countries)
          BODY=$(curl -s http://localhost:8080/api/countries)
          echo "Status: $STATUS"
          echo "Body: $BODY"
          [ "$STATUS" = "200" ] && echo "‚úÖ PASS" || (echo "‚ùå FAIL: $STATUS" && exit 1)
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert isinstance(data, list), 'Not a list'
          codes = [c['alpha2'] for c in data]
          assert codes == sorted(codes), f'Not sorted: {codes}'
          print(f'‚úÖ PASS: {len(data)} countries, sorted correctly')
          "

      - name: "‚úÖ Test 02/countries - filter by region"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8080/api/countries?region=Europe")
          BODY=$(curl -s "http://localhost:8080/api/countries?region=Europe")
          echo "Response body (first 500 chars):"
          echo "$BODY" | head -c 500
          echo ""
          [ "$STATUS" = "200" ] && echo "‚úÖ Status OK" || (echo "‚ùå FAIL: $STATUS" && exit 1)
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          if len(data) == 0:
              print('‚ùå FAIL: Empty response!')
              sys.exit(1)
          print(f'Countries returned: {len(data)}')
          print(f'First country: {data[0]}')
          regions = set(c.get('region') for c in data)
          print(f'Regions found: {regions}')
          if None in regions or '' in regions:
              print('‚ö†Ô∏è  WARNING: Some countries have no region')
          if regions - {None, ''} != {'Europe'}:
              print(f'‚ùå FAIL: Expected only Europe, got: {regions}')
              sys.exit(1)
          print(f'‚úÖ PASS: {len(data)} European countries')
          "

      - name: "‚úÖ Test 02/countries - invalid region = 400"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8080/api/countries?region=INVALID")
          [ "$STATUS" = "400" ] && echo "‚úÖ PASS: 400 for invalid region" || (echo "‚ùå FAIL: Got $STATUS, expected 400" && exit 1)

      - name: "‚úÖ Test 02/countries - by alpha2"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/countries/RU)
          BODY=$(curl -s http://localhost:8080/api/countries/RU)
          echo "Body: $BODY"
          [ "$STATUS" = "200" ] && echo "‚úÖ Status OK" || (echo "‚ùå FAIL: $STATUS" && exit 1)
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert data['alpha2'] == 'RU', f'Wrong country: {data}'
          print(f'‚úÖ PASS: Found {data[\"name\"]}')
          "

      - name: "‚úÖ Test 02/countries - unknown alpha2 = 404"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/countries/XX)
          [ "$STATUS" = "404" ] && echo "‚úÖ PASS: 404 for unknown country" || (echo "‚ùå FAIL: Got $STATUS, expected 404" && exit 1)

      # 8. Test 03/auth/register
      - name: "‚úÖ Test 03/register - success = 201"
        run: |
          BODY=$(curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"testuser","email":"test@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}')
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"testuser2","email":"test2@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}')
          echo "Register response: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert 'profile' in data, f'No profile: {data}'
          p = data['profile']
          for f in ['login','email','countryCode','isPublic']:
              assert f in p, f'Missing field: {f}'
          print(f'‚úÖ PASS: User {p[\"login\"]} registered')
          "

      - name: "‚úÖ Test 03/register - duplicate = 409"
        run: |
          curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"dupuser","email":"dup@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}' > /dev/null
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"dupuser","email":"dup2@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}')
          [ "$STATUS" = "409" ] && echo "‚úÖ PASS: 409 for duplicate" || (echo "‚ùå FAIL: Got $STATUS, expected 409" && exit 1)

      - name: "‚úÖ Test 03/register - weak password = 400"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"weakuser","email":"weak@example.com","password":"weak","countryCode":"RU","isPublic":true}')
          [ "$STATUS" = "400" ] && echo "‚úÖ PASS: 400 for weak password" || (echo "‚ùå FAIL: Got $STATUS, expected 400" && exit 1)

      # 9. Test 04/auth/sign-in
      - name: "‚úÖ Test 04/sign-in - success = 200 + token"
        run: |
          curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"signinuser","email":"signin@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}' > /dev/null
          BODY=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"signinuser","password":"Test123pass"}')
          echo "Sign-in response: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert 'token' in data, f'No token: {data}'
          assert len(data['token']) >= 20, 'Token too short'
          print(f'‚úÖ PASS: Token received (len={len(data[\"token\"])})')
          "

      - name: "‚úÖ Test 04/sign-in - wrong password = 401"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"signinuser","password":"WrongPass"}')
          [ "$STATUS" = "401" ] && echo "‚úÖ PASS: 401 for wrong password" || (echo "‚ùå FAIL: Got $STATUS, expected 401" && exit 1)

      # 10. Test 05/me - Get and Update Profile
      - name: "‚úÖ Test 05/me - GET /api/me/profile"
        run: |
          # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"profileuser","email":"profile@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}' > /dev/null
          
          # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
          TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"profileuser","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
          BODY=$(curl -s http://localhost:8080/api/me/profile -H "Authorization: Bearer $TOKEN")
          echo "Profile: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert 'profile' in data, 'No profile in response'
          p = data['profile']
          assert p['login'] == 'profileuser', 'Wrong login'
          assert p['email'] == 'profile@example.com', 'Email should be included for own profile'
          print('‚úÖ PASS: Own profile with email')
          "

      - name: "‚úÖ Test 05/me - PATCH /api/me/profile"
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
          TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"profileuser","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
          BODY=$(curl -s -X PATCH http://localhost:8080/api/me/profile \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"isPublic":false,"phone":"+79991234567","image":"https://example.com/avatar.jpg"}')
          
          echo "Updated profile: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          p = data['profile']
          assert p['isPublic'] == False, 'isPublic not updated'
          assert p['phone'] == '+79991234567', 'Phone not updated'
          assert p['image'] == 'https://example.com/avatar.jpg', 'Image not updated'
          print('‚úÖ PASS: Profile updated')
          "

      - name: "‚úÖ Test 05/me - PATCH empty body = 200"
        run: |
          TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"profileuser","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X PATCH http://localhost:8080/api/me/profile \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{}')
          
          [ "$STATUS" = "200" ] && echo "‚úÖ PASS: Empty PATCH returns 200" || (echo "‚ùå FAIL: Got $STATUS" && exit 1)

      # 11. Test 06/profiles - Get Profile by Login
      - name: "‚úÖ Test 06/profiles - public profile accessible"
        run: |
          # –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—É–±–ª–∏—á–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º
          curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"publicuser","email":"public@example.com","password":"Test123pass","countryCode":"RU","isPublic":true}' > /dev/null
          
          # –î—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω
          TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"profileuser","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          # –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
          BODY=$(curl -s http://localhost:8080/api/profiles/publicuser -H "Authorization: Bearer $TOKEN")
          echo "Public profile: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          p = data['profile']
          assert p['login'] == 'publicuser', 'Wrong user'
          assert 'email' not in p, 'Email should NOT be in other user profile'
          print('‚úÖ PASS: Public profile accessible, no email exposed')
          "

      - name: "‚úÖ Test 06/profiles - private profile not accessible = 403"
        run: |
          # –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∑–∞–∫—Ä—ã—Ç—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º
          curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"privateuser","email":"private@example.com","password":"Test123pass","countryCode":"RU","isPublic":false}' > /dev/null
          
          TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"profileuser","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/profiles/privateuser -H "Authorization: Bearer $TOKEN")
          
          [ "$STATUS" = "403" ] && echo "‚úÖ PASS: Private profile returns 403" || (echo "‚ùå FAIL: Got $STATUS, expected 403" && exit 1)

      - name: "‚úÖ Test 06/profiles - unknown user = 403"
        run: |
          TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"profileuser","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/profiles/nonexistent -H "Authorization: Bearer $TOKEN")
          
          [ "$STATUS" = "403" ] && echo "‚úÖ PASS: Unknown user returns 403" || (echo "‚ùå FAIL: Got $STATUS, expected 403" && exit 1)

      # 12. Test 07/password - Update Password
      - name: "‚úÖ Test 07/password - success"
        run: |
          TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"profileuser","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          BODY=$(curl -s -X POST http://localhost:8080/api/me/updatePassword \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"oldPassword":"Test123pass","newPassword":"NewPass123"}')
          
          echo "Password update: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert data.get('status') == 'ok', f'Wrong status: {data}'
          print('‚úÖ PASS: Password updated')
          "
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"profileuser","password":"Test123pass"}')
          
          [ "$STATUS" = "401" ] && echo "‚úÖ PASS: Old password rejected" || (echo "‚ùå FAIL: Old password still works" && exit 1)
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"profileuser","password":"NewPass123"}')
          
          [ "$STATUS" = "200" ] && echo "‚úÖ PASS: New password works" || (echo "‚ùå FAIL: New password doesn't work" && exit 1)

      - name: "‚úÖ Test 07/password - wrong old password = 403"
        run: |
          TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"profileuser","password":"NewPass123"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/me/updatePassword \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"oldPassword":"WrongOldPass","newPassword":"AnotherPass123"}')
          
          [ "$STATUS" = "403" ] && echo "‚úÖ PASS: Wrong old password returns 403" || (echo "‚ùå FAIL: Got $STATUS, expected 403" && exit 1)

      - name: "‚úÖ Test 07/password - weak new password = 400"
        run: |
          TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"profileuser","password":"NewPass123"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/me/updatePassword \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"oldPassword":"NewPass123","newPassword":"weak"}')
          
          [ "$STATUS" = "400" ] && echo "‚úÖ PASS: Weak password returns 400" || (echo "‚ùå FAIL: Got $STATUS, expected 400" && exit 1)

      # 13. Test 08/friends
      - name: "‚úÖ Test 08/friends - add friend"
        run: |
          # –°–æ–∑–¥–∞—ë–º –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"user1","email":"user1@example.com","password":"Test123pass","countryCode":"RU","isPublic":false}' > /dev/null
          curl -s -X POST http://localhost:8080/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"login":"user2","email":"user2@example.com","password":"Test123pass","countryCode":"RU","isPublic":false}' > /dev/null
          
          TOKEN1=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"user1","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          # –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è
          BODY=$(curl -s -X POST http://localhost:8080/api/friends/add \
            -H "Authorization: Bearer $TOKEN1" \
            -H "Content-Type: application/json" \
            -d '{"login":"user2"}')
          
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert data.get('status') == 'ok', f'Wrong status: {data}'
          print('‚úÖ PASS: Friend added')
          "

      - name: "‚úÖ Test 08/friends - list friends"
        run: |
          TOKEN1=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"user1","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          BODY=$(curl -s http://localhost:8080/api/friends -H "Authorization: Bearer $TOKEN1")
          echo "Friends list: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert isinstance(data, list), 'Not a list'
          assert len(data) >= 1, 'Friend not in list'
          assert data[0]['login'] == 'user2', f'Wrong friend: {data[0]}'
          assert 'addedAt' in data[0], 'Missing addedAt'
          print('‚úÖ PASS: Friends list correct')
          "

      - name: "‚úÖ Test 08/friends - remove friend"
        run: |
          TOKEN1=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"user1","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          BODY=$(curl -s -X POST http://localhost:8080/api/friends/remove \
            -H "Authorization: Bearer $TOKEN1" \
            -H "Content-Type: application/json" \
            -d '{"login":"user2"}')
          
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert data.get('status') == 'ok', f'Wrong status: {data}'
          print('‚úÖ PASS: Friend removed')
          "

      # 14. Test 09/posts - Create and Get Posts
      - name: "‚úÖ Test 09/posts - create post"
        run: |
          TOKEN1=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"user1","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          BODY=$(curl -s -X POST http://localhost:8080/api/posts/new \
            -H "Authorization: Bearer $TOKEN1" \
            -H "Content-Type: application/json" \
            -d '{"content":"My first post!","tags":["test","demo"]}')
          
          echo "Created post: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert 'id' in data, 'Missing post ID'
          assert data['content'] == 'My first post!', 'Wrong content'
          assert data['author'] == 'user1', 'Wrong author'
          assert data['tags'] == ['test', 'demo'], 'Wrong tags'
          assert 'createdAt' in data, 'Missing createdAt'
          assert data['likesCount'] == 0, 'Likes should be 0'
          assert data['dislikesCount'] == 0, 'Dislikes should be 0'
          print(f'Post ID: {data[\"id\"]}')
          with open('/tmp/post_id.txt', 'w') as f:
              f.write(data['id'])
          print('‚úÖ PASS: Post created')
          "

      - name: "‚úÖ Test 09/posts - get post by ID"
        run: |
          POST_ID=$(cat /tmp/post_id.txt)
          TOKEN1=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"user1","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          BODY=$(curl -s http://localhost:8080/api/posts/$POST_ID -H "Authorization: Bearer $TOKEN1")
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert data['content'] == 'My first post!', 'Wrong content'
          print('‚úÖ PASS: Post retrieved by ID')
          "

      - name: "‚úÖ Test 09/posts - access control (private profile)"
        run: |
          POST_ID=$(cat /tmp/post_id.txt)
          TOKEN2=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"user2","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          # user2 –Ω–µ –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –ø–æ—Å—Ç user1 (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å, –Ω–µ –¥—Ä—É–∑—å—è)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/posts/$POST_ID -H "Authorization: Bearer $TOKEN2")
          
          [ "$STATUS" = "404" ] && echo "‚úÖ PASS: Private post hidden from non-friends" || (echo "‚ùå FAIL: Got $STATUS, expected 404" && exit 1)

      # 15. Test 10/feed
      - name: "‚úÖ Test 10/feed - my feed"
        run: |
          TOKEN1=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"user1","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          # –°–æ–∑–¥–∞—ë–º –µ—â—ë –ø–æ—Å—Ç
          curl -s -X POST http://localhost:8080/api/posts/new \
            -H "Authorization: Bearer $TOKEN1" \
            -H "Content-Type: application/json" \
            -d '{"content":"Second post","tags":[]}' > /dev/null
          
          BODY=$(curl -s "http://localhost:8080/api/posts/feed/my?limit=10" -H "Authorization: Bearer $TOKEN1")
          echo "My feed: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert isinstance(data, list), 'Not a list'
          assert len(data) >= 2, f'Should have 2+ posts, got {len(data)}'
          # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ)
          assert data[0]['content'] == 'Second post', 'Wrong order'
          print('‚úÖ PASS: My feed correct')
          "

      - name: "‚úÖ Test 10/feed - user feed with access"
        run: |
          TOKEN1=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"user1","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          TOKEN2=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"user2","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          # user1 –¥–æ–±–∞–≤–ª—è–µ—Ç user2 –≤ –¥—Ä—É–∑—å—è
          curl -s -X POST http://localhost:8080/api/friends/add \
            -H "Authorization: Bearer $TOKEN1" \
            -H "Content-Type: application/json" \
            -d '{"login":"user2"}' > /dev/null
          
          # –¢–µ–ø–µ—Ä—å user2 –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –ª–µ–Ω—Ç—É user1
          BODY=$(curl -s http://localhost:8080/api/posts/feed/user1 -H "Authorization: Bearer $TOKEN2")
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert isinstance(data, list), 'Not a list'
          assert len(data) >= 2, 'Should see user1 posts'
          print('‚úÖ PASS: Friend can see private user feed')
          "

      # 16. Test 11/likes
      - name: "‚úÖ Test 11/likes - like post"
        run: |
          POST_ID=$(cat /tmp/post_id.txt)
          TOKEN2=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"user2","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          BODY=$(curl -s -X POST http://localhost:8080/api/posts/$POST_ID/like \
            -H "Authorization: Bearer $TOKEN2")
          
          echo "After like: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert data['likesCount'] == 1, f'Likes should be 1, got {data[\"likesCount\"]}'
          assert data['dislikesCount'] == 0, 'Dislikes should be 0'
          print('‚úÖ PASS: Like counted')
          "

      - name: "‚úÖ Test 11/likes - dislike post"
        run: |
          POST_ID=$(cat /tmp/post_id.txt)
          TOKEN2=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"user2","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          # user2 –º–µ–Ω—è–µ—Ç –º–Ω–µ–Ω–∏–µ –Ω–∞ dislike
          BODY=$(curl -s -X POST http://localhost:8080/api/posts/$POST_ID/dislike \
            -H "Authorization: Bearer $TOKEN2")
          
          echo "After dislike: $BODY"
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert data['likesCount'] == 0, 'Likes should be 0 (changed mind)'
          assert data['dislikesCount'] == 1, f'Dislikes should be 1, got {data[\"dislikesCount\"]}'
          print('‚úÖ PASS: Dislike replaces like')
          "

      - name: "‚úÖ Test 11/likes - multiple users"
        run: |
          POST_ID=$(cat /tmp/post_id.txt)
          TOKEN1=$(curl -s -X POST http://localhost:8080/api/auth/sign-in \
            -H "Content-Type: application/json" \
            -d '{"login":"user1","password":"Test123pass"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          
          # user1 (–∞–≤—Ç–æ—Ä) –ª–∞–π–∫–∞–µ—Ç —Å–≤–æ–π –ø–æ—Å—Ç
          curl -s -X POST http://localhost:8080/api/posts/$POST_ID/like \
            -H "Authorization: Bearer $TOKEN1" > /dev/null
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ç–æ–≥: user1=like, user2=dislike
          BODY=$(curl -s http://localhost:8080/api/posts/$POST_ID -H "Authorization: Bearer $TOKEN1")
          echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert data['likesCount'] == 1, f'Likes should be 1, got {data[\"likesCount\"]}'
          assert data['dislikesCount'] == 1, f'Dislikes should be 1, got {data[\"dislikesCount\"]}'
          print('‚úÖ PASS: Multiple users reactions work')
          "

      # 17. Summary
      - name: "üìä Summary"
        run: |
          echo ""
          echo "===================================="
          echo "       TEST RESULTS SUMMARY"
          echo "===================================="
          echo "  ‚úÖ 01/ping            1 point"
          echo "  ‚úÖ 02/countries       6 points"
          echo "  ‚úÖ 03/auth/register   6 points"
          echo "  ‚úÖ 04/auth/sign-in    7 points"
          echo "  ‚úÖ 05/me              8 points"
          echo "  ‚úÖ 06/profiles        5 points"
          echo "  ‚úÖ 07/password        7 points"
          echo "  ‚úÖ 08/friends        12 points"
          echo "  ‚úÖ 09/posts/publish  12 points"
          echo "  ‚úÖ 10/posts/feed     16 points"
          echo "  ‚úÖ 11/posts/likes    20 points"
          echo "------------------------------------"
          echo "  üéâ TOTAL: 100 / 100 points üéâ"
          echo "===================================="

      # 18. –õ–æ–≥–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      - name: Show app logs on failure
        if: failure()
        run: docker logs pulse-app 2>&1 || true
